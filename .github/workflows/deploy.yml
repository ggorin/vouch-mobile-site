# CI/CD Pipeline for Vouch Mobile Site
# Validates builds and monitors Sevalla automatic deployments

name: Build & Monitor Sevalla Deployment

on:
  push:
    branches:
      - main
  pull_request:
    branches:
      - main
  workflow_dispatch:  # Allow manual triggers

env:
  NODE_VERSION: '20.x'

jobs:
  # Build and validate the site locally before Sevalla deploys
  build:
    name: Build & Validate
    runs-on: ubuntu-latest
    outputs:
      build_status: ${{ steps.build.outcome }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Build site
        id: build
        run: npm run build

      - name: Verify build output
        run: |
          if [ ! -d "_site" ]; then
            echo "::error::Build failed - _site directory not found"
            exit 1
          fi
          echo "## Build Summary" >> $GITHUB_STEP_SUMMARY
          echo "✅ Build successful" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Output files:" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
          find _site -type f | head -20 >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
          FILE_COUNT=$(find _site -type f | wc -l)
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Total files:** $FILE_COUNT" >> $GITHUB_STEP_SUMMARY

      - name: Upload build artifacts
        uses: actions/upload-artifact@v4
        with:
          name: site-build
          path: _site/
          retention-days: 7

  # Monitor Sevalla's automatic deployment (only on push to main)
  monitor-deployment:
    name: Monitor Sevalla Deployment
    runs-on: ubuntu-latest
    needs: build
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    outputs:
      deployment_id: ${{ steps.deploy.outputs.deployment-id }}

    steps:
      - name: Wait for and monitor Sevalla deployment
        id: deploy
        uses: sevalla-hosting/sevalla-deploy@v1.0.1
        with:
          action: deploy-static-site
          sevalla-token: ${{ secrets.SEVALLA_TOKEN }}
          static-site-id: ${{ secrets.SEVALLA_STATIC_SITE_ID }}
          branch: main
          wait-for-finish: true

      - name: Write deployment summary
        if: always()
        env:
          DEPLOYMENT_ID: ${{ steps.deploy.outputs.deployment-id }}
          DEPLOY_ERROR: ${{ steps.deploy.outputs.error }}
        run: |
          echo "## Sevalla Deployment Status" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          if [ -n "$DEPLOYMENT_ID" ] && [ -z "$DEPLOY_ERROR" ]; then
            echo "✅ **Deployment successful**" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "**Deployment ID:** \`$DEPLOYMENT_ID\`" >> $GITHUB_STEP_SUMMARY
          else
            echo "❌ **Deployment failed**" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            if [ -n "$DEPLOY_ERROR" ]; then
              echo "**Error:** $DEPLOY_ERROR" >> $GITHUB_STEP_SUMMARY
            fi
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "Check [Sevalla Dashboard](https://my.sevalla.com) for logs." >> $GITHUB_STEP_SUMMARY
          fi

          echo "" >> $GITHUB_STEP_SUMMARY
          echo "---" >> $GITHUB_STEP_SUMMARY
          echo "**Commit:** \`$GITHUB_SHA\`" >> $GITHUB_STEP_SUMMARY
          echo "**Branch:** \`$GITHUB_REF_NAME\`" >> $GITHUB_STEP_SUMMARY
          echo "**Triggered by:** $GITHUB_ACTOR" >> $GITHUB_STEP_SUMMARY

  # Optional: Send notification on deployment
  notify:
    name: Send Notifications
    runs-on: ubuntu-latest
    needs: [build, monitor-deployment]
    if: always() && github.event_name == 'push' && github.ref == 'refs/heads/main'

    steps:
      - name: Determine status
        id: status
        env:
          BUILD_RESULT: ${{ needs.build.result }}
          DEPLOY_RESULT: ${{ needs.monitor-deployment.result }}
        run: |
          if [ "$BUILD_RESULT" = "success" ] && [ "$DEPLOY_RESULT" = "success" ]; then
            echo "status=success" >> $GITHUB_OUTPUT
            echo "message=✅ Vouch Mobile site deployed successfully" >> $GITHUB_OUTPUT
          elif [ "$BUILD_RESULT" = "failure" ]; then
            echo "status=failure" >> $GITHUB_OUTPUT
            echo "message=❌ Build failed - deployment blocked" >> $GITHUB_OUTPUT
          else
            echo "status=warning" >> $GITHUB_OUTPUT
            echo "message=⚠️ Deployment completed with warnings" >> $GITHUB_OUTPUT
          fi

      # Slack notification (optional - requires SLACK_WEBHOOK_URL secret)
      - name: Notify Slack
        if: vars.SLACK_NOTIFICATIONS_ENABLED == 'true'
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
          STATUS_MESSAGE: ${{ steps.status.outputs.message }}
        run: |
          curl -X POST "$SLACK_WEBHOOK_URL" \
            -H 'Content-type: application/json' \
            --data "{\"text\": \"$STATUS_MESSAGE\nCommit: $GITHUB_SHA\nBy: $GITHUB_ACTOR\"}"

      # Discord notification (optional - requires DISCORD_WEBHOOK_URL secret)
      - name: Notify Discord
        if: vars.DISCORD_NOTIFICATIONS_ENABLED == 'true'
        env:
          DISCORD_WEBHOOK_URL: ${{ secrets.DISCORD_WEBHOOK_URL }}
          STATUS_MESSAGE: ${{ steps.status.outputs.message }}
        run: |
          curl -X POST "$DISCORD_WEBHOOK_URL" \
            -H 'Content-type: application/json' \
            --data "{\"content\": \"$STATUS_MESSAGE\n\`\`\`Commit: $GITHUB_SHA\nBy: $GITHUB_ACTOR\`\`\`\"}"
